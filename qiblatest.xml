<?xml version="1.0" encoding="UTF-8"?>
<Module>
<ModulePrefs title="__MSG_title__"
    directory_title="__MSG_title__"
    author="Munawar Akbar"
    author_email="futureindustries@yahoo.com"
    thumbnail="http://qibla.googlecode.com/svn/trunk/thumb.png"
    screenshot="http://qibla.googlecode.com/svn/trunk/screen.png"
    category="tools"
    height="300"
    description="__MSG_description__">
    <Locale messages="http://qibla.googlecode.com/svn/trunk/ALL_ALL.xml"/>
    <Locale lang="en_GB" messages="http://qibla.googlecode.com/svn/trunk/en_GB.xml"/>
    <Locale lang="en_CA" messages="http://qibla.googlecode.com/svn/trunk/en_CA.xml"/>
		<Locale lang="fr" messages="http://qibla.googlecode.com/svn/trunk/fr_ALL.xml"/>
		<Locale lang="nl" messages="http://qibla.googlecode.com/svn/trunk/nl_ALL.xml"/>
		<Locale lang="tr" messages="http://qibla.googlecode.com/svn/trunk/tr_ALL.xml"/>
    <Require feature="com.google.gadgets.analytics"/>
		<Require feature="minimessage"/>
</ModulePrefs>

<UserPref
   name="location"
   display_name="__MSG_location__"
   datatype="string"
   default_value="Westminster Palace, London"/>

<UserPref
   name="zoom"
   display_name="__MSG_zoom__"
   datatype="string"
   default_value="12"/>

<UserPref
   name="country"
   display_name="__MSG_country__"
   datatype="string"
   default_value="uk"/>

<UserPref
   name="bg"
   display_name="__MSG_bg__"
   datatype="string"
   default_value="fff4c2"/>

<UserPref
   name="fg"
   display_name="__MSG_fg__"
   datatype="string"
   default_value="000000"/>

<Content type="html"><![CDATA[
<style>
.mmlib_table__MODULE_ID__ {background-color:#__UP_bg__;color:#__UP_fg__;}
.mmlib_table__MODULE_ID__ ol, .mmlib_table__MODULE_ID__ ul {padding-left:20px;}
.mmlib_table__MODULE_ID__ td {vertical-align:top;}
#form__MODULE_ID__ {margin:0;padding:0;height:20px;}
#geocode__MODULE_ID__ {width:99%;padding:0;margin:0;border-style:none;}
#geocode__MODULE_ID__ td {height:20px;padding:0;margin:0;}
#address__MODULE_ID__ {width:100%;height:20px;color:gray;font-size:70%;}
#buttons__MODULE_ID__ {width:32px;}
#address_btn__MODULE_ID__, #help_btn__MODULE_ID__{border-style:none;margin-left:3px;}
#map__MODULE_ID__ {width:100%;height:260px;}
#versions__MODULE_ID__ {float:left;width:100%;color:white;font-weight:bold;text-align:center;letter-spacing:0.2em;}
#versions__MODULE_ID__ div {float:left;width:50%;height:15px;}
#versions__MODULE_ID__ div:hover {color:#CCC; background-color:#FFCC00 !important;}
#desktop__MODULE_ID__ {background-color:#4B8C52;}
#mobile__MODULE_ID__ {background-color:#3C64B6;}
</style>
<!--[if lte IE 8]>
<style>
.mmlib_table__MODULE_ID__ ol, .mmlib_table__MODULE_ID__ ul {margin-left:25px; padding-left:0;}
</style>
<![endif]-->

<script src="http://www.google.com/jsapi?key=ABQIAAAAufA8C5iylDOIdtxKEJcoQBTZqGWfQErE9pT-IucjscazSdFnjBSJw14CqW91AnwlAcqbsWOlBhbz4w" type="text/javascript"></script>
<script type="text/javascript">
google.load("maps", "2");
var process__MODULE_ID__;

function Process__MODULE_ID__() {
  var obj = this;
  var prefs = new gadgets.Prefs(__MODULE_ID__);
  var country = prefs.getString("country");
  var zoom = prefs.getInt("zoom");
	var ipZoom = 9;
  var geoZoom = 16;
  var map;
  var xMrk;
  var poly;
  var qbLatLng = new google.maps.LatLng(21.422504762754905, 39.8261421918869);
  var geo = new google.maps.ClientGeocoder();
  var miniMsg = new gadgets.MiniMessage(__MODULE_ID__);
  var msg;
  var ga = new _IG_GA("UA-1059171-6");
  var analysed = false;
  var fileLoc = "http://qibla.googlecode.com/svn/trunk";

  this.getFileLoc = function() {
    return fileLoc;
  };

  this.init = function() {
    if (google.maps.BrowserIsCompatible()) {
      map = new google.maps.Map2(document.getElementById("map__MODULE_ID__"));
      var xIco = new google.maps.Icon();
      xIco.image = gadgets.io.getProxyUrl(this.getFileLoc() + "/crosshairs.gif");
      xIco.iconSize = new google.maps.Size(21, 21);
      xIco.iconAnchor = new google.maps.Point(11, 11);
      xIco.infoWindowAnchor = new google.maps.Point(11, 11);
      xMrk = new google.maps.Marker(new google.maps.LatLng(0, 0), {icon: xIco, clickable: false, title: prefs.getMsg("crosshairs")});
      var loc = google.loader.ClientLocation;
      var lat;
      var lng;

      if (loc) {
        lat = loc.latitude;
        lng = loc.longitude;
	      country = loc.address.country_code == "GB" ? "uk" : loc.address.country_code;
      }

      geo.setBaseCountryCode(country);

      if (!lat || !lng) {
        geo.getLatLng(prefs.getString('location'), centreMap);
      } else {
        this.centreLatLng(lat, lng, ipZoom);
      }

      map.setUIToDefault();

      google.maps.Event.addListener(map, "moveend", showOverlays);
      google.maps.Event.addListener(map, "dragend", function() {
        if (!analysed)
          ga.reportPageview("/qibla/navigate");
        analysed = true;
      });

      ga.reportPageview("/qibla");
    }
  };

  function centreMap(pLatLng, pZoom) {
	  var myZoom = (pZoom) ? pZoom : zoom;
    map.checkResize();		
    map.setCenter(pLatLng, myZoom);
    miniMsg.dismissMessage(msg);
    showOverlays(pLatLng);
  }

  this.centreLatLng = function(pLat, pLng, pZoom) {
    var latLng = new google.maps.LatLng(pLat, pLng);
		centreMap(latLng, pZoom);
  };

  function showOverlays() {
    var latLng = map.getCenter();
    map.clearOverlays();
    showXhair(latLng);
    flyCrow(latLng);
  }

  function showXhair(pLatLng) {
    xMrk.setLatLng(pLatLng);
    map.addOverlay(xMrk);
  }

  function flyCrow(pLatLng) {
    poly = new google.maps.Polyline([pLatLng, qbLatLng], "#ff0000", 1, 1, {geodesic:true});
    map.addOverlay(poly);
  }

  this.showAddr = function(pAddr) {
    geo.getLocations(pAddr, procAddr);
		miniMsg.dismissMessage(msg);
    if (!analysed)
      ga.reportPageview("/qibla/geocode");
    analysed = true;
    return false;
  };

  function procAddr(pAddrResult) {
    if (pAddrResult.Status.code == G_GEO_SUCCESS) {
      if (pAddrResult.Placemark.length > 1) {
        var msgTxt = "";
        for (var i=0; i < pAddrResult.Placemark.length; i++) {
          var p = pAddrResult.Placemark[i].Point.coordinates;
          msgTxt += "<a href='javascript:process__MODULE_ID__.centreLatLng(" + p[1] + "," + p[0] + "," + geoZoom + ")'>" + pAddrResult.Placemark[i].address + "</a>";
          if (i != pAddrResult.Placemark.length - 1)
            msgTxt += "<br />";
        }
				var div = document.createElement("div");
				div.innerHTML = msgTxt;
				msg = miniMsg.createDismissibleMessage(div);
				msg.style.cursor = "pointer";
      }
      else {
        var p = pAddrResult.Placemark[0].Point.coordinates;
        obj.centreLatLng(p[1], p[0], geoZoom);
      }
    }
    else {
      msg = miniMsg.createDismissibleMessage(prefs.getMsg(pAddrResult.Status.code));
    }
  }

  function dismissMsg() {
    miniMsg.dismissMessage(msg);
  }

  function listify(pTxt) {
    return "<li>" + pTxt + "</li>";
  }

  this.help = function() {
    miniMsg.dismissMessage(msg);
    var msgTxt = "<ol>" + listify(prefs.getMsg("help1")) + "<li>" + prefs.getMsg("help2") + "<ul>" +
       listify(prefs.getMsg("help2_2")) + listify(prefs.getMsg("help2_3")) + "</ul></li><li>" +
       prefs.getMsg("help3") + "<ul>" + listify(prefs.getMsg("help3_1")) + listify(prefs.getMsg("help3_2")) +
       listify(prefs.getMsg("help3_3")) + listify(prefs.getMsg("help3_4")) + "</ul></li></ol>" + 
			 "<br /><a href='http://gmodules.com/ig/creator?url=" + this.getFileLoc() + "/qibla.xml' target='_blank'>" + prefs.getMsg("add") + "</a>";
		var div = document.createElement("div");
		div.innerHTML = msgTxt;
		msg = miniMsg.createDismissibleMessage(div);		
    ga.reportPageview("/qibla/help");
  };
}

function init__MODULE_ID__() {
  process__MODULE_ID__ = new Process__MODULE_ID__();
  process__MODULE_ID__.init();
  document.getElementById("address_btn__MODULE_ID__").src = gadgets.io.getProxyUrl(process__MODULE_ID__.getFileLoc() + "/forward.gif");
  document.getElementById("help_btn__MODULE_ID__").src = gadgets.io.getProxyUrl(process__MODULE_ID__.getFileLoc() + "/question.gif");
}

function addrFocus(pAddr) {
  if (pAddr.value == "__MSG_address__") pAddr.value = "";
}

function addrBlur(pAddr) {
  if (pAddr.value == "") pAddr.value = "__MSG_address__";
}
gadgets.util.registerOnLoadHandler(init__MODULE_ID__);
</script>
<form id="form__MODULE_ID__" action="qibla.html" method="post" onsubmit="process__MODULE_ID__.showAddr(this.address__MODULE_ID__.value); return false">
<table id="geocode__MODULE_ID__" cellpadding="0" cellspacing="0">
<tr><td><input type="text" id="address__MODULE_ID__" maxlength="80" value="__MSG_address__" onfocus="addrFocus(this)" onblur="addrBlur(this)"/></td>
<td id="buttons__MODULE_ID__">
<input type="image" src="" id="address_btn__MODULE_ID__" alt="__MSG_address_btn__" title="__MSG_address_btn__" width="15" height="11" />
<a href="javascript:process__MODULE_ID__.help()"><img src="" id="help_btn__MODULE_ID__" alt="__MSG_help_btn__" title="__MSG_help_btn__" width="7" height="11" /></a>
</td></tr></table>
</form>
<div id="map__MODULE_ID__"></div>
<div id="versions__MODULE_ID__">
<div id="desktop__MODULE_ID__">http://www.qib.la</div><div id="mobile__MODULE_ID__">http://m.qib.la</div>
</div>
]]>
</Content>
</Module>